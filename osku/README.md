# OSKU/Feedback Service

Spring Boot App (service) for collecting feedback on living or working conditions within a building.


## Configuration
The configuration file application.properties is located in the spring-swagger-codegen-feedback/src/main/resources directory.

To change the default port for the application, modify: server.port=PORTNUMBER

You should also set permissions.link.baseuri property to match the service uri of the application instance (e.g. http://example.org:1234/user/create_user.html). The value is used when creating "create user" tokens. Incorrect value will produce invalid "create user" links for users.

### Database configuration

The application uses Hibernate's automatic schema generation, which can be configured by modifying: spring.jpa.hibernate.ddl-auto=MODE (e.g. MODE = "create" or "update" (without quotes) to create the initial database table schema).

Only external requirement for the service is a MySQL/MariaDB database instance. The database configuration for database address, username and password can be changed by modifying the following settings:
* spring.datasource.url=jdbc:mysql://localhost:3306/feedback_service?serverTimezone=UTC
* spring.datasource.username=MYSQLUSERNAME
* spring.datasource.password=MYSQLPASSWORD

The default database name is feedback_service (configured in the url above). The database should be pre-created before running the application with the MYSQLUSERNAME and MYSQLPASSWORD credentials given read and write access to the database. Check the databases-init.sql (in sql_scripts directory) for an example.

### SSL configuration

By-default the application is run without SSL. If you want to enable HTTPS directly on the Spring Boot App, you'll need a pkcs12 keystore file. The SSL configuration can be set up by un-commenting and modifying the properties:
* server.ssl.key-store: /PATH/TO/keystore.p12
* server.ssl.key-store-password: KEYSTOREPASSWORD
* server.ssl.key-store-type: PKCS12
* server.ssl.key-alias: SSLKEYALIASTOUSE
* server.ssl.key-password: SSLKEYPASSWORD

## Compilation

Minimum requirements to compile the application are Java SDK 11+ and Maven.

To compile the application, run "mvn package" in the root directory (where the pom.xml file is located). This will produce various class and status files in the "target" directory, and more importantly, the spring-swagger-codegen-feedback-0.0.1-SNAPSHOT.jar file, which can be used to run the application.

## Running the application

To run the service application a Java JRE 11+ is required, and the application can be run using the java-command, e.g. java -jar /PATH/TO/spring-swagger-codegen-feedback-0.0.1-SNAPSHOT.jar

### Initial user

By-default the application is initialized with an empty database. The initial user must be inserted manually in to the "user" and "user_authorities" tables _after_ the application has been started at least once (as the startup will generate the required tables).

See the create-user.sql in sql_scripts directory for an example. The password use bcrypt hashing, and in the example file the clear-text password is FEEDBACKPASSWORD. There are many tools for creating bcrypt hashed passwords, for example https://bcrypt.online.

The example script creates an admin role user, which has access to all questionares. You can also create a ROLE_USER user, which can have access only to a limited set of questionares (depending on the questionare parameters).

### API Documentation

The API documentation is automatically generated by Swagger and is available in the root of the service (e.g. http://example.org:1234).

The quickest way to get started is to use the Swagger UI to create a new "questionare" (in essence, a feedback form/query for the user):
* POST /questionares
 + id is ignored, and will be auto-generated for newly created (POSTed) questionaries.
 + set useServiceUsers to "false" if you want to allow people giving feedback to create their own questionare-specific users for the query. "true" will force the use of pre-generated service-level users (i.e., user added directly to the database, like the "initial user") for authentication.
 + Giving a location id is optional (the property can be left out), but if you want to try out a questionare with a location, see:
  - POST /locations for creating a new location (e.g. a building's floor illustrated by a blueprint) and POST /locations/{LOCATION_ID}/areas for creating new areas for the location (in essence, highlighted areas defined by polygon shapes)
 + Remember to take note of the identifier generated for the newly created questionare!
* POST /questionares/{QUESTIONARE_ID}/questions
 + As with POST /questionares, all ids are ignored.
 + indexNro can be used to arrange the order of questions in a questionare (question with the lowest number will be presented to the user first).
 + maxSelections can be used to limit how many options (listed in the value list) can be selected, and defaultvalue can be used to set the value selected as default.
 + text is the question text shown the user.
 + value list contains the options shown to the user.
  - colorHint defines the option selection checkbox's color in the user interface.
  - imageUrl can be used to replace the selection box with a clickable image
  - text is the option text in the user interface
  - value is the numeric value (pre-defined identifier) for the option. This should be unique to each value (selection option).
* POST /questionares/{QUESTIONARE_ID}/timeselections
 + Creating time selections if optional. Time selections can be used to pre-define the time periods (e.g. hourly day schedule) the user is allowed to pick when submitting feedback. If no time selections are created, the user interface will show a date/time picker, which allows user to report any time period (start and end time) for the feedback.
 + As before, id is ignored.
 + name is shown to the user as the description of the time selection (in the user interface)
 + start and end times, as UTC time (e.g. 00:00:00Z, HOURS:MINUTES:SECONDSZ).

### Questionare Users

Users with ROLE_ADMIN have full access to all questionares.

User with ROLE_USER have access only to a specific pre-configured set of questionares. The access is limited to reading the basic questionare details, and to submitting new feedback. ROLE_USER users can submit feedback (POST /questionares/{QUESTIONARE_ID}/answers), but NOT read the answers (GET /questionares/{QUESTIONARE_ID}/answers). Setting any other combination of permissions for ROLE_USER users requires manual modification of database tables.

If useServiceUsers is set to false, the questionare specific user creation option will be automatically shown for the questionare in the user interface. Optionally, POST /questionares/{QUESTIONARE_ID}/users can be used to manually create new questionare specific users.

If useServiceUsers is set to true, the user management can be handled through the /users end-point. The POST /users/token method can be used to generate links (and tokens) that can be used to create new users for a specific set of questionares. User created using the links/tokens will always be of ROLE_USER.

Note: removing users will NOT remove feedback given by the users. I.e. removing users will leave feedback with "unknown" user identifiers.

## OSKU Web User Interfaces

The web client for giving feedback can accessed using the path /feedback/index.html (e.g. http://example.org:1234/feedback/index.html), or through the login page /user/login.html.

By-default both pages will re-direct the user to the newest (most recently added) questionare the user has permissions to access. By using the query parameter ?questionare_id=QUESTIONARE_ID, both pages can be redirected to an alternative questionare. The authenticated user must have permissions for the questionare defined by QUESTIONARE_ID.

/user/login.html?logout=true can be used to logout the currently authenticated user. The web client uses HTML5 session storage for storing user credentials, and thus, simply closing the browser window will also "logout" the user.

The path /user/create_user.html?token=TOKEN can be used to create new users.

The /json-export/index.html has a helper page for exporting an existing questionare in JSON format supported by the /questionares end-point.

## Other Important Things to Note!

The OpenAPI 3.0 Yaml specification can be found in the api directory.

The current version of the web client has only the Finnish localization. Using other languages requires manual modifications to the HTML files located in spring-swagger-codegen-feedback/src/main/resources/static directory (in source codes). No easy way of changing the user language exists in current version. In a limited fashion other languages can be used by creating the questionares in the desired language, and ignoring (or commenting out in HTML) the Finnish help texts.

In the current implementation, only way to view questionare answers is using the API (GET /questionares/{QUESTIONARE_ID}/answers), no web page exists for listing answers.

And finally, NOTICE DAYLIGHT SAVING (DST). The service uses UTC time for storing answers. Time selections should also be inserted in UTC time. The current implementation does not handle DST in anyway, so be careful near DST/time changes.
